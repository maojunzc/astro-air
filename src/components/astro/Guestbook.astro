---
const { lang = "zh" } = Astro.props
const isChinese = lang === "zh"
---

<div class="my-10">
  <h3 class="mb-6 text-center text-xl font-bold">
    {isChinese ? "ç•™è¨€æ¿" : "Guestbook"}
  </h3>

  <!-- ç•™è¨€è¡¨å• -->
  <div class="rounded-lg bg-white p-6 shadow-md dark:bg-gray-800">
    <form id="guestbook-form" class="space-y-4">
      <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
        <div>
          <label
            for="name"
            class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
          >
            {isChinese ? "æ˜µç§°" : "Name"}
          </label>
          <input
            type="text"
            id="name"
            name="name"
            class="w-full rounded-md border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            placeholder={isChinese
              ? "è¯·è¾“å…¥æ‚¨çš„æ˜µç§° (é€‰å¡«)"
              : "Please enter your name (optional)"}
          />
        </div>
        <div>
          <label
            for="email"
            class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
          >
            {isChinese ? "é‚®ç®±" : "Email"}
          </label>
          <input
            type="email"
            id="email"
            name="email"
            class="w-full rounded-md border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            placeholder={isChinese
              ? "è¯·è¾“å…¥æ‚¨çš„é‚®ç®± (é€‰å¡«)"
              : "Please enter your email (optional)"}
          />
        </div>
        <div>
          <label
            for="website"
            class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
          >
            {isChinese ? "ç½‘å€" : "Website"}
          </label>
          <input
            type="url"
            id="website"
            name="website"
            class="w-full rounded-md border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            placeholder={isChinese
              ? "è¯·è¾“å…¥æ‚¨çš„ç½‘å€ (http://)"
              : "Please enter your website (http://)"}
          />
        </div>
      </div>
      <div>
        <label
          for="message"
          class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
        >
          {isChinese ? "ç•™è¨€å†…å®¹" : "Message"}
        </label>
        <!-- ç•™è¨€å†…å®¹æ¡†ï¼Œå¸¦æœ‰æ¯æ—¥ä¸€è¨€èƒŒæ™¯ -->
        <div class="relative">
          <textarea
            id="message"
            name="message"
            rows={6}
            required
            class="w-full resize-none rounded-md border border-gray-300 px-4 py-4 focus:ring-2 focus:ring-blue-500 focus:outline-none dark:border-gray-600 dark:bg-gray-700 dark:text-white"
          ></textarea>
          <!-- æ¯æ—¥ä¸€è¨€èƒŒæ™¯ -->
          <div
            id="quote-background"
            class="pointer-events-none absolute inset-0 z-0 flex flex-col items-center justify-center overflow-hidden p-6"
          >
            <div
              class="max-w-full text-center transition-all duration-500 ease-in-out"
            >
              <p
                id="guestbook-daily-quote"
                class="text-center text-base leading-relaxed font-light tracking-wide text-gray-100 opacity-60 md:text-lg dark:text-gray-800"
              >
              </p>
              <p
                id="guestbook-quote-author"
                class="mt-2 text-xs font-light text-gray-200 italic opacity-50 dark:text-gray-700"
              >
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="flex items-center justify-end">
        <button
          type="submit"
          class="rounded-md bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-2.5 text-white shadow-md transition-all hover:from-blue-700 hover:to-blue-800 hover:shadow-lg"
        >
          {isChinese ? "æäº¤ç•™è¨€" : "Submit"}
        </button>
      </div>
    </form>
  </div>

  <!-- ç•™è¨€åˆ—è¡¨ -->
  <div class="mt-10">
    <h4
      class="mb-6 border-b border-gray-200 pb-2 text-lg font-semibold dark:border-gray-700"
    >
      {isChinese ? "ç•™è¨€åˆ—è¡¨" : "Messages"}
    </h4>
    <div id="guestbook-messages" class="space-y-4">
      <!-- ç•™è¨€å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
      <div class="rounded-lg bg-white p-5 shadow-sm dark:bg-gray-800">
        <div class="mb-3 flex items-center justify-between">
          <div class="flex items-center">
            <div
              class="mr-3 flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-blue-400 to-blue-600 font-bold text-white"
            >
              A
            </div>
            <div>
              <p class="font-medium text-gray-800 dark:text-gray-200">
                Anonymous
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-400">2026-02-27</p>
            </div>
          </div>
        </div>
        <p class="pl-13 text-gray-700 dark:text-gray-300">
          æ¬¢è¿å¤§å®¶ç•™è¨€äº¤æµï¼ğŸ˜Š
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  // å¤‡ç”¨ä¸€è¨€æ•°æ®
  const fallbackQuotes = [
    { text: "å²æœˆé™å¥½ï¼Œç°ä¸–å®‰ç¨³", author: "èƒ¡å…°æˆ" },
    { text: "ä½ ç«™åœ¨æ¡¥ä¸Šçœ‹é£æ™¯ï¼Œçœ‹é£æ™¯çš„äººåœ¨æ¥¼ä¸Šçœ‹ä½ ", author: "åä¹‹ç³" },
    { text: "æ„¿ä½ åœ¨å°˜ä¸–è·å¾—å¹¸ç¦", author: "æµ·å­" },
    { text: "äººç”Ÿè‹¥åªå¦‚åˆè§", author: "çº³å…°æ€§å¾·" },
    { text: "é¢æœå¤§æµ·ï¼Œæ˜¥æš–èŠ±å¼€", author: "æµ·å­" },
  ]

  // APIåˆ—è¡¨
  const apiEndpoints = [
    {
      url: "https://v1.hitokoto.cn/",
      parse: (data) => ({
        text: data.hitokoto,
        author: data.from_who || data.from || "Unknown",
      }),
    },
    {
      url: "https://api.shadiao.pro/du",
      parse: (data) => ({ text: data.text, author: data.from || "Unknown" }),
    },
    {
      url: "https://lbx.xiaoxiao-dashu.com/api/yiyan",
      parse: (data) => ({
        text: data.data.text,
        author: data.data.author || "Unknown",
      }),
    },
  ]

  // è·å–ä¸€è¨€
  async function getQuoteFromAPI() {
    // å…ˆå°è¯•ä½¿ç”¨æœ¬åœ°API
    try {
      const response = await fetch("/api/quotes")
      if (response.ok) {
        const data = await response.json()
        if (data && data.text) {
          return {
            text: data.text,
            author: data.author || "Unknown",
          }
        }
      }
    } catch (e) {
      console.log("Using API quotes")
    }

    // éšæœºæ‰“ä¹±APIé¡ºåº
    const shuffledAPIs = [...apiEndpoints].sort(() => Math.random() - 0.5)

    for (const api of shuffledAPIs) {
      try {
        const controller = new AbortController()
        const timeoutId = setTimeout(() => controller.abort(), 3000)

        const response = await fetch(api.url, { signal: controller.signal })
        clearTimeout(timeoutId)

        if (!response.ok) continue

        const data = await response.json()
        const quote = api.parse(data)

        if (quote.text && quote.text.length > 0) {
          return quote
        }
      } catch (error) {
        continue
      }
    }

    // æ‰€æœ‰APIéƒ½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ•°æ®
    const randomIndex = Math.floor(Math.random() * fallbackQuotes.length)
    return fallbackQuotes[randomIndex]
  }

  // æ›´æ–°æ¯æ—¥ä¸€è¨€èƒŒæ™¯
  async function updateDailyQuoteBackground() {
    const quote = await getQuoteFromAPI()

    const quoteElement = document.getElementById("guestbook-daily-quote")
    const authorElement = document.getElementById("guestbook-quote-author")

    if (quoteElement) {
      const text = quote.text
      const maxLength = 20
      let displayText = text

      if (text.length > maxLength) {
        const mid = Math.floor(text.length / 2)
        const spaceIndex = text.indexOf(" ", mid)
        if (spaceIndex !== -1 && spaceIndex < text.length - 5) {
          displayText =
            text.substring(0, spaceIndex) +
            "<br/>" +
            text.substring(spaceIndex + 1)
        } else {
          displayText =
            text.substring(0, maxLength) + "<br/>" + text.substring(maxLength)
        }
      }

      quoteElement.innerHTML = displayText
    }

    if (authorElement) {
      authorElement.textContent = "â€” " + quote.author
    }
  }

  // å¤„ç†ç•™è¨€æäº¤
  async function handleSubmit(e) {
    e.preventDefault()

    const form = e.target
    const formData = new FormData(form)

    const name = formData.get("name")
    const email = formData.get("email")
    const website = formData.get("website")
    const message = formData.get("message")

    if (!message || message.trim() === "") {
      alert(isChinese ? "è¯·è¾“å…¥ç•™è¨€å†…å®¹" : "Please enter your message")
      return
    }

    try {
      const response = await fetch("/api/guestbook", {
        method: "POST",
        body: formData,
      })

      const result = await response.json()

      if (result.success) {
        alert(isChinese ? "ç•™è¨€æäº¤æˆåŠŸï¼" : "Message submitted successfully!")
        form.reset()
        addMessageToList({ name, email, website, message })
      } else {
        alert(
          isChinese
            ? "ç•™è¨€æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•"
            : "Failed to submit message, please try again",
        )
      }
    } catch (error) {
      console.error("æäº¤å¤±è´¥:", error)
      alert(
        isChinese
          ? "ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•"
          : "Network error, please try again later",
      )
    }
  }

  // æ·»åŠ ç•™è¨€åˆ°åˆ—è¡¨
  function addMessageToList(messageData) {
    const messagesContainer = document.getElementById("guestbook-messages")

    const messageElement = document.createElement("div")
    messageElement.className =
      "bg-white dark:bg-gray-800 rounded-lg shadow-sm p-5"

    const today = new Date()
    const dateString = today.toISOString().split("T")[0]

    const initial = messageData.name
      ? messageData.name.charAt(0).toUpperCase()
      : "A"

    messageElement.innerHTML = `
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center">
          <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold mr-3">
            ${initial}
          </div>
          <div>
            <p class="font-medium text-gray-800 dark:text-gray-200">${messageData.name || "Anonymous"}</p>
            <p class="text-xs text-gray-500 dark:text-gray-400">${dateString}</p>
          </div>
        </div>
      </div>
      <p class="text-gray-700 dark:text-gray-300 pl-13">${messageData.message}</p>
    `

    messagesContainer.insertBefore(messageElement, messagesContainer.firstChild)
  }

  // é¡µé¢åŠ è½½æ—¶æ›´æ–°æ¯æ—¥ä¸€è¨€èƒŒæ™¯
  document.addEventListener("DOMContentLoaded", function () {
    updateDailyQuoteBackground()

    const form = document.getElementById("guestbook-form")
    if (form) {
      form.addEventListener("submit", handleSubmit)
    }
  })
</script>
